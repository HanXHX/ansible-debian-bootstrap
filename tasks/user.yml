---

- name: USER | Add groups to the system
  group: >
    name={{ item.name }}
    system={{ item.system | default('no') }}
  with_items: dbs_groups

- name: USER | Add users to the system
  user: >
    name={{ item.name }}
    shell={{ item.shell | default('/bin/bash') }}
    comment={{ item.comment | default('') }}
    group={{ item.group | default('') }}
    groups={{ item.groups | default('') }}
    home={{ item.home | default('/home/' + item.name) }}
    createhome={{ item.createhome | default('yes') }}
    system={{ item.system | default('no') }}
  with_items: dbs_users
  register: u

- name: AUTHORIZED_KEY | Install SSH public key to system users
  authorized_key: user="{{ item.0.name }}" key="{{ item.1 }}"
  with_subelements:
    - dbs_users
    - ssh_keys

- name: TEMPLATE | Create sudoers file
  template: >
    src=etc/sudoers.d/ansible.j2
    dest=/etc/sudoers.d/ansible
    mode=0440
    validate='visudo -cf %s'
  when: u.changed

